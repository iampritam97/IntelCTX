<?php
require_once 'db.php';
include 'partials/header.php';
$pdo = get_db();

$search = $_GET['q'] ?? '';
$stmt = $pdo->prepare("SELECT * FROM malware_families WHERE name LIKE ? OR description LIKE ? ORDER BY name ASC");
$stmt->execute(["%$search%", "%$search%"]);
$rows = $stmt->fetchAll();

// Fetch APT mapping for each malware
$appMapStmt = $pdo->prepare("SELECT name FROM apt_groups WHERE malware_families LIKE ?");
?>

<section class="space-y-6 text-sm">
  <div>
    <h1 class="text-xl font-bold text-primary">Malware Family Encyclopedia</h1>
    <p class="text-xs text-slate-500">Pivot malware → APT usage and compare defender hypotheses.</p>
  </div>

  <!-- Search bar -->
  <form method="get" class="flex gap-2">
    <input type="text" name="q" value="<?php echo htmlspecialchars($search); ?>" placeholder="Search malware or keywords…" 
      class="w-full border border-border rounded-md px-3 py-2 text-sm bg-white">
    <button type="submit" 
      class="border border-border rounded-md px-4 py-2 hover:bg-slate-100 transition text-sm font-medium">
      Search
    </button>
  </form>

  <!-- Malware Cards Grid -->
  <div class="grid sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <?php foreach ($rows as $r): 
      $appMapStmt->execute(["%".$r['name']."%"]);
      $aptUsers = $appMapStmt->fetchAll();
    ?>
      <div class="bg-white border border-border rounded-xl shadow-sm p-4 hover:shadow-md transition">
        
        <div class="flex justify-between items-start mb-2">
          <h2 class="text-md font-semibold text-primary"><?php echo htmlspecialchars($r['name']); ?></h2>

          <!-- Optional Compare select later in compare page -->
          <button onclick="selectMalware('<?php echo $r['name']; ?>')" 
            class="text-[10px] border border-border rounded px-2 py-1 hover:bg-slate-50 transition">
            + Compare
          </button>
        </div>

        <p class="text-xs text-slate-600 line-clamp-3"><?php echo htmlspecialchars($r['description'] ?: 'No description'); ?></p>

        <div class="mt-2">
          <p class="text-[10px] font-bold uppercase text-slate-500 mb-1">Used By APT</p>
          <div class="flex flex-wrap gap-1">
            <?php foreach($aptUsers as $u): ?>
              <a href="apt.php?q=<?php echo urlencode($u['name']); ?>" 
                class="text-[10px] underline text-accent"><?php echo htmlspecialchars($u['name']); ?></a>
            <?php endforeach; ?>
            <?php if (!$aptUsers): ?><span class="text-slate-400 text-[10px]">None tagged</span><?php endif; ?>
          </div>
        </div>
      </div>
    <?php endforeach; ?>
  </div>

  <?php if (!$rows): ?>
    <p class="text-sm text-slate-500">No malware families found.</p>
  <?php endif; ?>
</section>

<!-- Script for future Compare Page Integration -->
<script>
function selectMalware(name) {
  let list = JSON.parse(localStorage.getItem('compareMalware') || '[]');
  if (!list.includes(name)) list.push(name);
  localStorage.setItem('compareMalware', JSON.stringify(list));
  alert("Added to comparison queue");
}
</script>

<?php include 'partials/footer.php'; ?>
