<?php
require_once __DIR__ . '/../auth.php';
require_login();
$pdo = get_db();

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$editing = $id > 0;

if ($editing) {
    $stmt = $pdo->prepare("SELECT * FROM malware_families WHERE id = ?");
    $stmt->execute([$id]);
    $m = $stmt->fetch();
    if (!$m) die("Malware not found");
} else {
    $m = [
      'name' => '',
      'description' => '',
      'mitre_id' => '',
      'malware_type' => '',
      'capabilities' => '',
      'artifacts' => '',
      'behavior_summary' => '',
      'yara_rules' => '',
      'detection_opportunities' => '',
      'references_section' => ''
    ];
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {

    $fields = [
        'name','description','mitre_id','malware_type',
        'capabilities','artifacts','behavior_summary',
        'yara_rules','detection_opportunities','references_section'
    ];

    $data = [];
    foreach ($fields as $f) $data[$f] = $_POST[$f] ?? '';

    if ($editing) {
        $sql = "UPDATE malware_families SET
                name=:name,
                description=:description,
                mitre_id=:mitre_id,
                malware_type=:malware_type,
                capabilities=:capabilities,
                artifacts=:artifacts,
                behavior_summary=:behavior_summary,
                yara_rules=:yara_rules,
                detection_opportunities=:detection_opportunities,
                references_section=:references_section
                WHERE id=:id";

        $data['id'] = $id;
        $stmt = $pdo->prepare($sql);
        $stmt->execute($data);

    } else {
        $sql = "INSERT INTO malware_families
                (name, description, mitre_id, malware_type, capabilities,
                 artifacts, behavior_summary, yara_rules,
                 detection_opportunities, references_section)
                VALUES
                (:name,:description,:mitre_id,:malware_type,:capabilities,
                 :artifacts,:behavior_summary,:yara_rules,
                 :detection_opportunities,:references_section)";

        $stmt = $pdo->prepare($sql);
        $stmt->execute($data);
    }

    header("Location: malware_list.php");
    exit;
}

include __DIR__ . '/../partials/header.php';
?>

<section class="space-y-4 text-sm">
  <h1 class="text-lg font-semibold"><?= $editing ? "Edit Malware Family" : "Add Malware Family" ?></h1>

  <form method="post" class="bg-white border border-border rounded-lg p-4 grid md:grid-cols-2 gap-4 text-xs">

    <div>
      <label class="block mb-1">Name</label>
      <input name="name" required class="w-full border border-border rounded px-2 py-1.5"
             value="<?= htmlspecialchars($m['name']); ?>">
    </div>

    <div>
      <label class="block mb-1">MITRE ID</label>
      <input name="mitre_id" class="w-full border border-border rounded px-2 py-1.5"
             value="<?= htmlspecialchars($m['mitre_id']); ?>">
    </div>

    <div>
      <label class="block mb-1">Malware Type</label>
      <input name="malware_type" class="w-full border border-border rounded px-2 py-1.5"
             value="<?= htmlspecialchars($m['malware_type']); ?>">
    </div>

    <div class="md:col-span-2">
      <label class="block mb-1">Description</label>
      <textarea name="description" class="w-full border border-border rounded px-2 py-1.5 h-20"><?= htmlspecialchars($m['description']); ?></textarea>
    </div>

    <div class="md:col-span-2">
      <label class="block mb-1">Capabilities</label>
      <textarea name="capabilities" class="w-full border border-border rounded px-2 py-1.5 h-20"><?= htmlspecialchars($m['capabilities']); ?></textarea>
    </div>

    <div class="md:col-span-2">
      <label class="block mb-1">Artifacts</label>
      <textarea name="artifacts" class="w-full border border-border rounded px-2 py-1.5 h-20"><?= htmlspecialchars($m['artifacts']); ?></textarea>
    </div>

    <div class="md:col-span-2">
      <label class="block mb-1">Behavior Summary</label>
      <textarea name="behavior_summary" class="w-full border border-border rounded px-2 py-1.5 h-20"><?= htmlspecialchars($m['behavior_summary']); ?></textarea>
    </div>

    <div class="md:col-span-2">
      <label class="block mb-1">YARA Rules</label>
      <textarea name="yara_rules" class="w-full border border-border rounded px-2 py-1.5 h-24 font-mono"><?= htmlspecialchars($m['yara_rules']); ?></textarea>
    </div>

    <div class="md:col-span-2">
      <label class="block mb-1">Detection Opportunities</label>
      <textarea name="detection_opportunities" class="w-full border border-border rounded px-2 py-1.5 h-20"><?= htmlspecialchars($m['detection_opportunities']); ?></textarea>
    </div>

    <div class="md:col-span-2">
      <label class="block mb-1">References</label>
      <textarea name="references_section" class="w-full border border-border rounded px-2 py-1.5 h-20"><?= htmlspecialchars($m['references_section']); ?></textarea>
    </div>

    <button class="md:col-span-2 bg-accent text-white px-4 py-2 rounded hover:opacity-90 transition">
      Save Malware Family
    </button>

  </form>
</section>

<?php include __DIR__ . '/../partials/footer.php'; ?>
