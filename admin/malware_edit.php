<?php
require_once __DIR__ . '/../auth.php';
require_login();
$pdo = get_db();

$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$editing = $id > 0;

if ($editing) {
    $stmt = $pdo->prepare("SELECT * FROM malware_families WHERE id = ?");
    $stmt->execute([$id]);
    $m = $stmt->fetch();
    if (!$m) die("Malware not found");
} else {
    $m = [
      'name' => '',
      'description' => '',
      'mitre_id' => '',
      'malware_type' => '',
      'capabilities' => '',
      'artifacts' => '',
      'behavior_summary' => '',
      'yara_rules' => '',
      'detection_opportunities' => '',
      'references_section' => ''
    ];
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {

    $fields = [
        'name','description','mitre_id','malware_type',
        'capabilities','artifacts','behavior_summary',
        'yara_rules','detection_opportunities','references_section'
    ];

    $data = [];
    foreach ($fields as $f) $data[$f] = $_POST[$f] ?? '';

    if ($editing) {
        $sql = "UPDATE malware_families SET
                name=:name,
                description=:description,
                mitre_id=:mitre_id,
                malware_type=:malware_type,
                capabilities=:capabilities,
                artifacts=:artifacts,
                behavior_summary=:behavior_summary,
                yara_rules=:yara_rules,
                detection_opportunities=:detection_opportunities,
                references_section=:references_section
                WHERE id=:id";

        $data['id'] = $id;
        $stmt = $pdo->prepare($sql);
        $stmt->execute($data);

    } else {
        $sql = "INSERT INTO malware_families
                (name, description, mitre_id, malware_type, capabilities,
                 artifacts, behavior_summary, yara_rules,
                 detection_opportunities, references_section)
                VALUES
                (:name,:description,:mitre_id,:malware_type,:capabilities,
                 :artifacts,:behavior_summary,:yara_rules,
                 :detection_opportunities,:references_section)";

        $stmt = $pdo->prepare($sql);
        $stmt->execute($data);
    }

    header("Location: malware_list.php");
    exit;
}

include __DIR__ . '/../partials/header.php';
?>

<section class="space-y-6 text-sm">

  <h1 class="text-2xl font-bold tracking-tight text-primary">
      <?= $editing ? "Edit Malware Family" : "Add Malware Family" ?>
  </h1>

  <!-- FORM CONTAINER -->
  <form method="post"
        class="bg-ht_bg2 border border-ht_border rounded-xl p-6 shadow-lg
               grid md:grid-cols-2 gap-6 text-xs backdrop-blur-xl">

      <!-- LEFT COLUMN -->
      <div class="space-y-4">

          <div>
              <label class="block mb-1 text-ht_muted font-semibold text-[11px]">Name</label>
              <input name="name" required
                     class="w-full rounded-lg px-3 py-2 bg-ht_bg border border-ht_border
                            text-ht_text focus:ring-1 focus:ring-ht_blue"
                     value="<?= htmlspecialchars($m['name']); ?>">
          </div>

          <div>
              <label class="block mb-1 text-ht_muted font-semibold text-[11px]">MITRE ID</label>
              <input name="mitre_id"
                     class="w-full rounded-lg px-3 py-2 bg-ht_bg border border-ht_border
                            text-ht_text"
                     value="<?= htmlspecialchars($m['mitre_id']); ?>">
          </div>

          <div>
              <label class="block mb-1 text-ht_muted font-semibold text-[11px]">Malware Type</label>
              <input name="malware_type"
                     class="w-full rounded-lg px-3 py-2 bg-ht_bg border border-ht_border text-ht_text"
                     value="<?= htmlspecialchars($m['malware_type']); ?>">
          </div>

      </div>

      <!-- RIGHT COLUMN -->
      <div class="space-y-4">

          <div>
              <label class="block mb-1 text-ht_muted font-semibold text-[11px]">Description</label>
              <textarea name="description"
                        class="w-full h-24 rounded-lg px-3 py-2 bg-ht_bg border border-ht_border
                               text-ht_text"><?= htmlspecialchars($m['description']); ?></textarea>
          </div>

          <div>
              <label class="block mb-1 text-ht_muted font-semibold text-[11px]">Capabilities</label>
              <textarea name="capabilities"
                        class="w-full h-24 rounded-lg px-3 py-2 bg-ht_bg border border-ht_border
                               text-ht_text"><?= htmlspecialchars($m['capabilities']); ?></textarea>
          </div>

      </div>

      <!-- FULL-WIDTH ROWS -->

      <div class="md:col-span-2 space-y-4">

          <div>
              <label class="block mb-1 text-ht_muted font-semibold text-[11px]">Artifacts</label>
              <textarea name="artifacts"
                        class="w-full h-24 rounded-lg px-3 py-2 bg-ht_bg border border-ht_border
                               text-ht_text"><?= htmlspecialchars($m['artifacts']); ?></textarea>
          </div>

          <div>
              <label class="block mb-1 text-ht_muted font-semibold text-[11px]">Behavior Summary</label>
              <textarea name="behavior_summary"
                        class="w-full h-24 rounded-lg px-3 py-2 bg-ht_bg border border-ht_border
                               text-ht_text"><?= htmlspecialchars($m['behavior_summary']); ?></textarea>
          </div>

          <div>
              <label class="block mb-1 text-ht_muted font-semibold text-[11px]">YARA Rules</label>
              <textarea name="yara_rules"
                        class="w-full h-28 font-mono rounded-lg px-3 py-2 bg-ht_bg border border-ht_border
                               text-ht_text"><?= htmlspecialchars($m['yara_rules']); ?></textarea>
          </div>

          <div>
              <label class="block mb-1 text-ht_muted font-semibold text-[11px]">Detection Opportunities</label>
              <textarea name="detection_opportunities"
                        class="w-full h-24 rounded-lg px-3 py-2 bg-ht_bg border border-ht_border
                               text-ht_text"><?= htmlspecialchars($m['detection_opportunities']); ?></textarea>
          </div>

          <div>
              <label class="block mb-1 text-ht_muted font-semibold text-[11px]">References</label>
              <textarea name="references_section"
                        class="w-full h-24 rounded-lg px-3 py-2 bg-ht_bg border border-ht_border
                               text-ht_text"><?= htmlspecialchars($m['references_section']); ?></textarea>
          </div>

      </div>

      <!-- SUBMIT BUTTON -->
      <button
        class="md:col-span-2 bg-ht_blue text-white py-2.5 rounded-lg font-semibold hover:bg-blue-600
               transition shadow-md">
          Save Malware Family
      </button>

  </form>

</section>


<?php include __DIR__ . '/../partials/footer.php'; ?>
