<?php
require_once __DIR__ . '/../auth.php';
require_login();
$pdo = get_db();

$total = $pdo->query("SELECT COUNT(*) FROM malware_families")->fetchColumn();
$hasYara = $pdo->query("SELECT COUNT(*) FROM malware_families WHERE yara_rules <> ''")->fetchColumn();
$withMITRE = $pdo->query("SELECT COUNT(*) FROM malware_families WHERE mitre_id <> ''")->fetchColumn();
$types = $pdo->query("SELECT malware_type, COUNT(*) as c FROM malware_families GROUP BY malware_type")->fetchAll();

include __DIR__ . '/../partials/header.php';
?>

<section class="space-y-6">

  <h1 class="text-xl font-bold">Malware Dashboard</h1>

  <!-- Metric cards -->
  <div class="grid md:grid-cols-3 gap-4">

    <div class="bg-white border border-border rounded-xl p-4 shadow-sm">
      <p class="text-xs text-slate-500 uppercase">Total Malware Families</p>
      <p class="text-3xl font-bold"><?= $total ?></p>
    </div>

    <div class="bg-white border border-border rounded-xl p-4 shadow-sm">
      <p class="text-xs text-slate-500 uppercase">Families with YARA</p>
      <p class="text-3xl font-bold text-accent"><?= $hasYara ?></p>
    </div>

    <div class="bg-white border border-border rounded-xl p-4 shadow-sm">
      <p class="text-xs text-slate-500 uppercase">MITRE Mapped</p>
      <p class="text-3xl font-bold text-green-600"><?= $withMITRE ?></p>
    </div>

  </div>

  <!-- Malware Types -->
  <div class="bg-white border border-border rounded-xl p-6 shadow-sm">
    <h2 class="text-lg font-semibold mb-3">Malware Types</h2>
    <ul class="space-y-1 text-sm">
      <?php foreach ($types as $t): ?>
        <li><?= htmlspecialchars($t['malware_type'] ?: "Unknown") ?> â€” 
          <span class="font-bold"><?= $t['c'] ?></span></li>
      <?php endforeach; ?>
    </ul>
  </div>

</section>

<?php include __DIR__ . '/../partials/footer.php'; ?>
