<?php
require_once __DIR__ . '/../auth.php';
require_login();
$pdo = get_db();

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['csv'])) {

    $file = fopen($_FILES['csv']['tmp_name'], 'r');
    while (($row = fgetcsv($file)) !== false) {

        list($name, $description, $type, $mitre) = $row;

        $stmt = $pdo->prepare("INSERT INTO malware_families
          (name, description, malware_type, mitre_id)
          VALUES (?, ?, ?, ?)");
        $stmt->execute([$name, $description, $type, $mitre]);
    }
    fclose($file);

    header("Location: malware_list.php?imported=1");
    exit;
}

include __DIR__ . '/../partials/header.php';
?>

<section class="space-y-4 text-sm">
  <h1 class="text-lg font-semibold">Bulk Import Malware (CSV)</h1>

  <form method="post" enctype="multipart/form-data" class="bg-white border border-border rounded p-4">
    <input type="file" name="csv" accept=".csv"
      class="border border-border p-2 rounded w-full mb-3" required>
    
    <button class="bg-accent text-white px-4 py-2 rounded">Import CSV</button>
  </form>

  <p class="text-xs text-slate-500 mt-2">
    CSV Format: name, description, malware_type, mitre_id
  </p>
</section>

<?php include __DIR__ . '/../partials/footer.php'; ?>
