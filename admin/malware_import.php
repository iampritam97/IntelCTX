<?php
require_once __DIR__ . '/../auth.php';
require_login();
$pdo = get_db();

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['csv'])) {

    $file = fopen($_FILES['csv']['tmp_name'], 'r');
    while (($row = fgetcsv($file)) !== false) {

        list($name, $description, $type, $mitre) = $row;

        $stmt = $pdo->prepare("INSERT INTO malware_families
          (name, description, malware_type, mitre_id)
          VALUES (?, ?, ?, ?)");
        $stmt->execute([$name, $description, $type, $mitre]);
    }
    fclose($file);

    header("Location: malware_list.php?imported=1");
    exit;
}

include __DIR__ . '/../partials/header.php';
?>

<section class="space-y-6 text-sm">

  <div class="flex items-center justify-between">
    <h1 class="text-xl font-bold text-primary">Bulk Import Malware (CSV)</h1>
    <a href="malware_list.php" class="text-xs underline text-accent">← Back to Malware List</a>
  </div>

  <div class="bg-ht_card border border-ht_border rounded-xl p-6 shadow-md backdrop-blur-xl">

    <h2 class="text-sm font-semibold text-ht_blue mb-3">Upload CSV File</h2>

    <form method="post" enctype="multipart/form-data" class="space-y-4">

      <div>
        <input type="file" name="csv" accept=".csv"
          class="w-full text-xs file:bg-ht_blue file:text-white file:border-0 
                 file:px-3 file:py-1.5 file:rounded-md file:cursor-pointer
                 border border-ht_border rounded-lg bg-ht_bg2 p-2 text-primary" required>
      </div>

      <button class="bg-ht_blue text-white px-4 py-2 rounded-lg text-xs font-semibold 
                     hover:bg-blue-600 transition">
        Import CSV
      </button>
    </form>

    <div class="mt-4 p-3 bg-ht_bg2 border border-ht_border rounded-lg text-xs text-ht_muted">
      <p class="font-semibold text-primary mb-1">CSV Format:</p>
      <p><span class="font-mono">name, description, malware_type, mitre_id</span></p>

      <p class="mt-3 text-[11px]">
        • Ensure UTF-8 encoding<br>
        • Avoid commas inside fields unless using quotes<br>
        • Duplicate names will be imported as separate entries
      </p>
    </div>

  </div>

</section>


<?php include __DIR__ . '/../partials/footer.php'; ?>
