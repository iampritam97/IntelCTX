<?php
require_once __DIR__ . '/../auth.php';
require_login();
$pdo = get_db();

$page = isset($_GET['page']) ? max(1, (int)$_GET['page']) : 1;
$perPage = 12;
$offset = ($page - 1) * $perPage;

// Count total rows
$total = $pdo->query("SELECT COUNT(*) FROM malware_families")->fetchColumn();
$totalPages = ceil($total / $perPage);

// Fetch paginated rows
$stmt = $pdo->prepare("SELECT * FROM malware_families ORDER BY name ASC LIMIT ? OFFSET ?");
$stmt->bindValue(1, $perPage, PDO::PARAM_INT);
$stmt->bindValue(2, $offset, PDO::PARAM_INT);
$stmt->execute();
$rows = $stmt->fetchAll();


$rows = $pdo->query("SELECT * FROM malware_families ORDER BY name ASC")->fetchAll();

include __DIR__ . '/../partials/header.php';
?>

<section class="space-y-8 text-sm">

  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold tracking-tight text-primary">Malware Families</h1>
      <p class="text-xs text-slate-500 mt-1">Admin control panel for malware taxonomy</p>
    </div>

    <a href="malware_edit.php"
       class="px-4 py-2 text-xs bg-accent text-white rounded-lg shadow-sm hover:bg-accent/90 transition">
       + Add New Malware
    </a>
  </div>

  <!-- Grid -->
<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
  <?php foreach ($rows as $r): ?>
    <div
      class="rounded-xl p-5 border border-ht_border bg-ht_bg2 
             shadow-lg/5 hover:shadow-lg hover:bg-ht_bg transition-all">

      <!-- Name -->
      <h2 class="text-sm font-semibold text-ht_text">
        <?= htmlspecialchars($r['name']); ?>
      </h2>

      <!-- MITRE ID (Badge) -->
      <?php if ($r['mitre_id']): ?>
        <span class="inline-block text-[10px] px-2 py-0.5 mt-1
                     rounded bg-ht_blue/20 text-ht_blue font-mono">
          <?= htmlspecialchars($r['mitre_id']); ?>
        </span>
      <?php endif; ?>

      <!-- Description -->
      <p class="text-xs text-ht_muted mt-3 line-clamp-3">
        <?= htmlspecialchars($r['description']); ?>
      </p>

      <!-- Actions -->
      <div class="mt-4 flex justify-between items-center text-xs">

        <a href="malware_edit.php?id=<?= $r['id']; ?>"
           class="text-ht_blue hover:underline">
          Edit
        </a>

        <a href="malware_delete.php?id=<?= $r['id']; ?>"
           onclick="return confirm('Delete this malware family?');"
           class="text-red-500 hover:text-red-400 hover:underline">
          Delete
        </a>

      </div>

      <!-- MITRE Enrich -->
      <div class="mt-2">
        <a href="malware_enrich.php"
           class="text-[11px] text-ht_blue hover:underline">
          Enrich via MITRE Offline Data →
        </a>
      </div>

    </div>
  <?php endforeach; ?>
</div>


  <!-- Pagination -->
  <div class="flex justify-center mt-8 gap-2 text-xs">

    <?php if ($page > 1): ?>
      <a href="?page=<?= $page-1 ?>"
         class="px-3 py-1 rounded-md border border-border hover:bg-slate-100 dark:hover:bg-gray-800">
         ‹ Prev
      </a>
    <?php endif; ?>

    <span class="px-3 py-1 border border-border dark:border-gray-800 rounded-md bg-slate-100 dark:bg-gray-800">
      Page <?= $page ?> of <?= $totalPages ?>
    </span>

    <?php if ($page < $totalPages): ?>
      <a href="?page=<?= $page+1 ?>"
         class="px-3 py-1 rounded-md border border-border hover:bg-slate-100 dark:hover:bg-gray-800">
         Next ›
      </a>
    <?php endif; ?>

  </div>

</section>


<?php include __DIR__ . '/../partials/footer.php'; ?>
