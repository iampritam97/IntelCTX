<?php
require_once __DIR__ . '/../auth.php';
require_login();
$pdo = get_db();

$page = isset($_GET['page']) ? max(1, (int)$_GET['page']) : 1;
$perPage = 12;
$offset = ($page - 1) * $perPage;

// Count total rows
$total = $pdo->query("SELECT COUNT(*) FROM malware_families")->fetchColumn();
$totalPages = ceil($total / $perPage);

// Fetch paginated rows
$stmt = $pdo->prepare("SELECT * FROM malware_families ORDER BY name ASC LIMIT ? OFFSET ?");
$stmt->bindValue(1, $perPage, PDO::PARAM_INT);
$stmt->bindValue(2, $offset, PDO::PARAM_INT);
$stmt->execute();
$rows = $stmt->fetchAll();


$rows = $pdo->query("SELECT * FROM malware_families ORDER BY name ASC")->fetchAll();

include __DIR__ . '/../partials/header.php';
?>

<section class="space-y-6 text-sm">
  <h1 class="text-xl font-bold">Malware Families (Admin)</h1>
  <a href="malware_edit.php" class="underline text-accent text-sm">+ Add New Malware</a>

  <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
    <?php foreach ($rows as $r): ?>
      <div class="bg-white border border-border rounded-xl p-4 shadow-sm">
        <h2 class="text-md font-semibold"><?= htmlspecialchars($r['name']); ?></h2>

        <?php if ($r['mitre_id']): ?>
          <p class="text-[10px] text-slate-500">MITRE: <?= htmlspecialchars($r['mitre_id']); ?></p>
        <?php endif; ?>

        <p class="text-xs text-slate-600 line-clamp-3 mt-2"><?= htmlspecialchars($r['description']); ?></p>

        <div class="mt-3 flex justify-between text-xs">
          <a href="malware_edit.php?id=<?= $r['id']; ?>" class="underline text-blue-600">Edit</a>
          <a href="malware_delete.php?id=<?= $r['id']; ?>" class="underline text-red-600"
             onclick="return confirm('Delete this malware family?');">
             Delete
          </a>
          <a href="malware_enrich.php" class="underline text-accent text-sm">
  Enrich via MITRE Offline Data
</a>

        </div>
      </div>
    <?php endforeach; ?>
  </div>
<!-- Pagination -->
<div class="flex justify-center mt-6 gap-2 text-xs">

  <?php if ($page > 1): ?>
    <a href="?page=<?= $page-1 ?>" class="px-3 py-1 border border-border rounded hover:bg-slate-50">‹ Prev</a>
  <?php endif; ?>

  <span class="px-3 py-1 border border-border rounded bg-slate-100">
    Page <?= $page ?> of <?= $totalPages ?>
  </span>

  <?php if ($page < $totalPages): ?>
    <a href="?page=<?= $page+1 ?>" class="px-3 py-1 border border-border rounded hover:bg-slate-50">Next ›</a>
  <?php endif; ?>

</div>

</section>

<?php include __DIR__ . '/../partials/footer.php'; ?>
