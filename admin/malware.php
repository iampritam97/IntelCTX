<?php
require_once __DIR__ . '/../auth.php';
require_login();
$pdo = get_db();

// Insert
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $name = trim($_POST['name'] ?? '');
    $desc = trim($_POST['description'] ?? '');
    if ($name !== '') {
        $stmt = $pdo->prepare("INSERT INTO malware_families (name, description) VALUES (?, ?)
            ON DUPLICATE KEY UPDATE description=VALUES(description)");
        $stmt->execute([$name, $desc]);
    }
    header('Location: malware.php');
    exit;
}

// Delete
if (isset($_GET['delete'])) {
    $id = (int)$_GET['delete'];
    $pdo->prepare("DELETE FROM malware_families WHERE id=?")->execute([$id]);
    header('Location: malware.php');
    exit;
}

$rows = $pdo->query("SELECT * FROM malware_families ORDER BY name")->fetchAll();
include __DIR__ . '/../partials/header.php';
?>
<section class="space-y-4 text-sm">
    <div class="flex justify-between items-center">
        <h1 class="text-lg font-semibold">Malware Family Master</h1>
        <a href="dashboard.php" class="border border-slate-300 rounded px-3 py-1 text-xs">Back</a>
    </div>

    <form method="post" class="bg-white border border-slate-200 rounded p-3 grid md:grid-cols-3 gap-3 text-xs">
        <div>
            <label class="block mb-1">Name</label>
            <input name="name" class="w-full border border-slate-300 rounded px-2 py-1.5">
        </div>
        <div class="md:col-span-2">
            <label class="block mb-1">Description</label>
            <input name="description" class="w-full border border-slate-300 rounded px-2 py-1.5">
        </div>
        <div class="md:col-span-3 flex justify-end">
            <button class="border border-slate-400 rounded px-3 py-1.5">Save</button>
        </div>
    </form>

    <div class="bg-white border border-slate-200 rounded p-3">
        <table class="min-w-full text-xs">
            <thead class="border-b border-slate-200 text-slate-500">
                <tr>
                    <th class="text-left py-1 pr-4">Name</th>
                    <th class="text-left py-1 pr-4">Description</th>
                    <th class="text-right py-1">Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($rows as $r): ?>
                    <tr class="border-b border-slate-100">
                        <td class="py-1 pr-4"><?php echo htmlspecialchars($r['name']); ?></td>
                        <td class="py-1 pr-4"><?php echo htmlspecialchars($r['description']); ?></td>
                        <td class="py-1 text-right">
                            <a href="?delete=<?php echo $r['id']; ?>"
                               onclick="return confirm('Delete entry?');"
                               class="underline text-red-600">Delete</a>
                        </td>
                    </tr>
                <?php endforeach; ?>
                <?php if (!$rows): ?>
                    <tr><td colspan="3" class="py-2 text-slate-500">No entries yet.</td></tr>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</section>
<?php include __DIR__ . '/../partials/footer.php'; ?>
